name: Test Action

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test-validation:
    name: Test Input Validation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Test validation script
        run: |
          # Test valid environments
          node scripts/validate.js ci ./scripts '' client-id tenant-id https://fusion.equinor.com
          node scripts/validate.js fqa ./scripts '' client-id tenant-id https://fusion.equinor.com
          node scripts/validate.js fprd ./scripts '' client-id tenant-id https://fusion.equinor.com
          node scripts/validate.js tr ./scripts '' client-id tenant-id https://fusion.equinor.com
          
          # Test custom environments
          node scripts/validate.js pr-123 ./scripts '' client-id tenant-id https://fusion.equinor.com
          node scripts/validate.js ci-feature ./scripts '' client-id tenant-id https://fusion.equinor.com
          
          # Test token authentication
          node scripts/validate.js ci ./scripts dummy-token-123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890 '' '' ''
          
          echo "✅ All validation tests passed!"

  test-action-syntax:
    name: Test Action Syntax
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Validate action.yml syntax
        uses: docker://rhysd/action-validator:latest
        with:
          args: action.yml

  # Mock test of the actual action (without real publishing)
  test-action-mock:
    name: Mock Action Test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Create mock artifact
        run: |
          mkdir -p dist
          echo '<!DOCTYPE html><html><head><title>Test App</title></head><body>Test</body></html>' > dist/index.html
          echo 'console.log("test");' > dist/app.js
          echo '{"name":"test-app","version":"1.0.0"}' > dist/manifest.json
      
      - name: Test action validation only
        uses: ./
        with:
          # This will fail at Azure login, but validation should pass
          azure-client-id: 'test-client-id'
          azure-tenant-id: 'test-tenant-id' 
          azure-resource-id: 'https://fusion.equinor.com'
          env: 'ci'
          artifact: 'dist'
          build-before-publish: 'false'
        continue-on-error: true
        id: action-test
      
      - name: Check validation passed
        run: |
          if [ "${{ steps.action-test.outcome }}" = "success" ]; then
            echo "✅ Action validation passed (expected to fail at auth)"
          else
            echo "✅ Action failed as expected at authentication step"
          fi