name: ci

on:
  push:
    branches:
      - main

concurrency: ${{ github.workflow }}-${{ github.ref }}

# Security: Apply principle of least privilege
# This workflow handles action versioning and GitHub releases
permissions:
  contents: write      # Required for creating releases and pushing tags
  id-token: write      # Required for OIDC token generation
  pull-requests: write # Required for changesets action to create PRs

jobs:
  release-action:
    name: Version or publish GitHub Action
    runs-on: ubuntu-latest
    outputs:
      published: ${{ steps.changesets.outputs.published }}
      hasChangesets: ${{ steps.changesets.outputs.hasChangesets }}
    steps:
      # Checkout repository with full history for changeset processing
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      # Configure git user for commits made by the workflow
      - name: Configure git user (trigger actor) 
        uses: ./.github/workflows/actions/config-git-user
      
      # Install dependencies and setup Node.js environment
      - name: Setup node and install deps
        uses: ./.github/workflows/actions/node-setup

      # Run tests to ensure quality before release
      - name: Run tests
        run: pnpm run test:ci

      # Run linting to ensure code quality
      - name: Run linter
        run: pnpm run lint

      # Build and package the action with latest source changes
      - name: Build and package action
        run: pnpm run build

      # Check if dist files need to be committed
      - name: Check for dist changes
        id: dist-changes
        run: |
          if [[ -n $(git status --porcelain dist/) ]]; then
            echo "‚ùå dist/ files are out of date!"
            echo "Please run 'pnpm run build' and commit the updated dist/ files."
            echo ""
            echo "Changed files:"
            git status --porcelain dist/
            echo ""
            echo "To fix this:"
            echo "1. Run: pnpm run build"
            echo "2. Run: git add dist/"  
            echo "3. Run: git commit -m 'build: update dist files'"
            echo "4. Push your changes"
            exit 1
          else
            echo "‚úÖ dist/ files are up to date"
          fi

      # Process changesets: create version PR or create GitHub releases
      - name: Create Release Pull Request or Create GitHub Release
        if: github.actor != 'dependabot[bot]'
        id: changesets
        uses: changesets/action@v1
        with:
          title: 'ü§ñ Release - Fusion Action App Publish'
          createGithubReleases: true
          setupGitUser: false
          version: pnpm run changeset:version
        env:
          GITHUB_TOKEN: ${{ github.token }}

      # Convert changeset PR to draft to prevent accidental merging
      - name: Convert Changeset PR to draft
        if: steps.changesets.outputs.published == 'false' && steps.changesets.outputs.pullRequestNumber
        run: gh pr ready ${{ steps.changesets.outputs.pullRequestNumber }} --undo
        env:
          GH_TOKEN: ${{ github.token }}

      # Create git tags for GitHub Action versioning (v1, v1.2, v1.2.3)
      - name: Create/Update Action Tags
        if: steps.changesets.outputs.hasChangesets == 'false' && steps.changesets.outputs.pullRequestNumber == ''
        run: |
          # Get the latest version from package.json
          VERSION=$(node -p "require('./package.json').version")
          echo "Published version: $VERSION"
          
          # Create version tags for GitHub Actions marketplace
          git tag -f "v${VERSION}"
          
          # Create major version tag (e.g., v1 from v1.2.3)
          MAJOR_VERSION=$(echo $VERSION | cut -d. -f1)
          git tag -f "v${MAJOR_VERSION}"
          
          # Create minor version tag (e.g., v1.2 from v1.2.3)  
          MINOR_VERSION=$(echo $VERSION | cut -d. -f1-2)
          git tag -f "v${MINOR_VERSION}"
          
          # Push tags
          git push origin --tags --force
        env:
          GITHUB_TOKEN: ${{ github.token }}