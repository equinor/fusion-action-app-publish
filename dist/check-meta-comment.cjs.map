{"version":3,"file":"check-meta-comment.cjs","sources":["../src/core/check-meta-comment.ts"],"sourcesContent":["/**\n * check-meta-comment.ts\n * Checks if a meta comment already exists on the PR to avoid duplicate comments\n */\n\nimport * as core from \"@actions/core\";\nimport * as github from \"@actions/github\";\n\n/**\n * Checks if a meta comment already exists on the PR\n * @returns true if meta comment exists, false otherwise\n */\nexport async function checkMetaComment(): Promise<boolean> {\n  try {\n    const token = process.env.GITHUB_TOKEN;\n    if (!token) {\n      core.info(\"GITHUB_TOKEN not available\");\n      return false;\n    }\n\n    const context = github.context;\n    const tag = core.getInput(\"tag\");\n\n    // Extract PR number from context or tag\n    const prNumber =\n      context.payload.pull_request?.number ||\n      (tag?.startsWith(\"pr-\") ? parseInt(tag.replace(\"pr-\", \"\"), 10) : null);\n\n    if (!prNumber) {\n      core.info(\"Not a PR deployment, no meta comment check needed\");\n      return false;\n    }\n\n    const octokit = github.getOctokit(token);\n\n    try {\n      const comments = await octokit.rest.issues.listComments({\n        owner: context.repo.owner,\n        repo: context.repo.repo,\n        issue_number: prNumber,\n      });\n\n      const exists = comments.data.some((comment) =>\n        comment.body?.includes(\"<!-- fusion-app-publish-meta -->\"),\n      );\n\n      if (exists) {\n        core.info(`Meta comment already exists on PR #${prNumber}, will skip posting`);\n        core.setOutput(\"exists\", \"true\");\n      } else {\n        core.info(`No existing meta comment found on PR #${prNumber}`);\n        core.setOutput(\"exists\", \"false\");\n      }\n\n      return exists;\n    } catch (error: unknown) {\n      const message = error instanceof Error ? error.message : \"Unknown error\";\n      core.warning(`Failed to check for existing meta comment: ${message}`);\n      return false;\n    }\n  } catch (error: unknown) {\n    const message = error instanceof Error ? error.message : \"Unknown error\";\n    core.setFailed(`Check meta comment failed: ${message}`);\n    throw error;\n  }\n}\n\n// Execute if called directly\nif (require.main === module) {\n  checkMetaComment();\n}\n"],"names":["core","github"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;AAYA,eAAsB,mBAAqC;AACzD,MAAI;AACF,UAAM,QAAQ,QAAQ,IAAI;AAC1B,QAAI,CAAC,OAAO;AACVA,sBAAK,KAAK,4BAA4B;AACtC,aAAO;AAAA,IACT;AAEA,UAAM,UAAUC,kBAAO;AACvB,UAAM,MAAMD,gBAAK,SAAS,KAAK;AAG/B,UAAM,WACJ,QAAQ,QAAQ,cAAc,WAC7B,KAAK,WAAW,KAAK,IAAI,SAAS,IAAI,QAAQ,OAAO,EAAE,GAAG,EAAE,IAAI;AAEnE,QAAI,CAAC,UAAU;AACbA,sBAAK,KAAK,mDAAmD;AAC7D,aAAO;AAAA,IACT;AAEA,UAAM,UAAUC,kBAAO,WAAW,KAAK;AAEvC,QAAI;AACF,YAAM,WAAW,MAAM,QAAQ,KAAK,OAAO,aAAa;AAAA,QACtD,OAAO,QAAQ,KAAK;AAAA,QACpB,MAAM,QAAQ,KAAK;AAAA,QACnB,cAAc;AAAA,MAAA,CACf;AAED,YAAM,SAAS,SAAS,KAAK;AAAA,QAAK,CAAC,YACjC,QAAQ,MAAM,SAAS,kCAAkC;AAAA,MAAA;AAG3D,UAAI,QAAQ;AACVD,wBAAK,KAAK,sCAAsC,QAAQ,qBAAqB;AAC7EA,wBAAK,UAAU,UAAU,MAAM;AAAA,MACjC,OAAO;AACLA,wBAAK,KAAK,yCAAyC,QAAQ,EAAE;AAC7DA,wBAAK,UAAU,UAAU,OAAO;AAAA,MAClC;AAEA,aAAO;AAAA,IACT,SAAS,OAAgB;AACvB,YAAM,UAAU,iBAAiB,QAAQ,MAAM,UAAU;AACzDA,sBAAK,QAAQ,8CAA8C,OAAO,EAAE;AACpE,aAAO;AAAA,IACT;AAAA,EACF,SAAS,OAAgB;AACvB,UAAM,UAAU,iBAAiB,QAAQ,MAAM,UAAU;AACzDA,oBAAK,UAAU,8BAA8B,OAAO,EAAE;AACtD,UAAM;AAAA,EACR;AACF;AAGA,IAAI,QAAQ,SAAS,QAAQ;AAC3B,mBAAA;AACF;;"}