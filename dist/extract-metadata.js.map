{"version":3,"file":"extract-metadata.js","sources":["../src/core/extract-metadata.ts"],"sourcesContent":["/**\n * extract-metadata.ts\n *\n * Loads metadata from a Fusion application bundle (zip) file\n *\n * This module extracts application metadata (name, version, appKey) from the bundle's\n * metadata.json file. The metadata is used for deployment tracking and URL generation.\n *\n * Throws an error if the metadata.json file is missing or cannot be parsed.\n */\nimport * as path from \"node:path\";\nimport * as core from \"@actions/core\";\nimport AdmZip from \"adm-zip\";\nimport type { AppMetadata } from \"../types\";\n\n/**\n * The shape of the metadata loaded from the bundle zip file.\n */\nexport type BundleMetadata = {\n  appKey: string;\n  name: string;\n  version: string;\n};\n\n/**\n * Loads the metadata from a bundle zip file.\n * @param bundle - The AdmZip instance representing the bundle.\n * @returns A promise resolving to an object containing name and version.\n * @throws If metadata.json is missing or cannot be parsed.\n */\nexport const loadMetadata = (bundle: AdmZip): Promise<BundleMetadata> => {\n  // Attempt to retrieve the metadata.json entry from the zip bundle\n  const metadataEntry =\n    bundle.getEntry(\"metadata.json\") ??\n    bundle.getEntries().find((entry) => entry.entryName.endsWith(\"/metadata.json\"));\n  if (!metadataEntry) {\n    // If not found, throw an error\n    throw new Error(\"Metadata file not found in bundle\");\n  }\n  // Read the metadata entry asynchronously\n  return new Promise((resolve, reject) => {\n    metadataEntry.getDataAsync((data, err) => {\n      if (err) {\n        // Reject if reading the file fails\n        return reject(new Error(\"Failed to read metadata file\", { cause: err }));\n      }\n      try {\n        // Parse the metadata as JSON and resolve\n        return resolve(JSON.parse(String(data)));\n      } catch (error) {\n        // Reject if parsing fails\n        reject(new Error(\"Failed to parse metadata file\", { cause: error }));\n      }\n    });\n  });\n};\n\n/**\n * Extracts app metadata from the artifact\n * Uses AdmZip library to read the metadata directly from the zip file\n * without extracting to temporary files for better performance and security\n * @param artifactPath - Path to the artifact\n * @returns Parsed app metadata with mapped fields\n */\nexport async function extractAppMetadata(artifactPath: string): Promise<AppMetadata> {\n  try {\n    const artifactExtension = path.extname(artifactPath).toLowerCase();\n    if (artifactExtension !== \".zip\") {\n      throw new Error(\n        `Unsupported artifact format: ${artifactExtension}. Only .zip files are supported.`,\n      );\n    }\n\n    const zip = new AdmZip(artifactPath);\n    const metadata = await loadMetadata(zip);\n\n    // Map the metadata to AppMetadata format\n    const appMetadata: AppMetadata = {\n      name: metadata.name,\n      version: metadata.version,\n      key: metadata.appKey || metadata.name,\n    };\n\n    return appMetadata;\n  } catch (error: unknown) {\n    const message = error instanceof Error ? error.message : \"Unknown error\";\n    core.error(`Failed to extract app metadata: ${message}`);\n    throw error;\n  }\n}\n"],"names":["error","core.error"],"mappings":";;;AA8BO,MAAM,eAAe,CAAC,WAA4C;AAEvE,QAAM,gBACJ,OAAO,SAAS,eAAe,KAC/B,OAAO,WAAA,EAAa,KAAK,CAAC,UAAU,MAAM,UAAU,SAAS,gBAAgB,CAAC;AAChF,MAAI,CAAC,eAAe;AAElB,UAAM,IAAI,MAAM,mCAAmC;AAAA,EACrD;AAEA,SAAO,IAAI,QAAQ,CAAC,SAAS,WAAW;AACtC,kBAAc,aAAa,CAAC,MAAM,QAAQ;AACxC,UAAI,KAAK;AAEP,eAAO,OAAO,IAAI,MAAM,gCAAgC,EAAE,OAAO,IAAA,CAAK,CAAC;AAAA,MACzE;AACA,UAAI;AAEF,eAAO,QAAQ,KAAK,MAAM,OAAO,IAAI,CAAC,CAAC;AAAA,MACzC,SAASA,QAAO;AAEd,eAAO,IAAI,MAAM,iCAAiC,EAAE,OAAOA,OAAA,CAAO,CAAC;AAAA,MACrE;AAAA,IACF,CAAC;AAAA,EACH,CAAC;AACH;AASA,eAAsB,mBAAmB,cAA4C;AACnF,MAAI;AACF,UAAM,oBAAoB,KAAK,QAAQ,YAAY,EAAE,YAAA;AACrD,QAAI,sBAAsB,QAAQ;AAChC,YAAM,IAAI;AAAA,QACR,gCAAgC,iBAAiB;AAAA,MAAA;AAAA,IAErD;AAEA,UAAM,MAAM,IAAI,OAAO,YAAY;AACnC,UAAM,WAAW,MAAM,aAAa,GAAG;AAGvC,UAAM,cAA2B;AAAA,MAC/B,MAAM,SAAS;AAAA,MACf,SAAS,SAAS;AAAA,MAClB,KAAK,SAAS,UAAU,SAAS;AAAA,IAAA;AAGnC,WAAO;AAAA,EACT,SAASA,SAAgB;AACvB,UAAM,UAAUA,mBAAiB,QAAQA,QAAM,UAAU;AACzDC,UAAW,mCAAmC,OAAO,EAAE;AACvD,UAAMD;AAAAA,EACR;AACF;"}