{"version":3,"file":"extract-manifest.js","sources":["../src/core/extract-manifest.ts"],"sourcesContent":["import path from \"node:path\";\nimport { fileURLToPath } from \"node:url\";\nimport * as core from \"@actions/core\";\nimport AdmZip from \"adm-zip\";\n\n/**\n * The shape of the manifest loaded from the bundle zip file.\n * Normally contains more fields, but we only care about appKey here.\n * Used for publish config.\n */\nexport type Manifest = {\n  appKey: string;\n} & Record<string, unknown>;\n\n/**\n * Loads the manifest from a bundle zip file.\n * @param bundle - The AdmZip instance representing the bundle.\n * @returns A promise resolving to an object containing the manifest.\n * @throws If app.manifest.json is missing or cannot be parsed.\n */\nexport const loadManifest = (bundle: AdmZip): Promise<Manifest> => {\n  const manifestEntry =\n    bundle.getEntry(\"app.manifest.json\") ??\n    bundle.getEntries().find((entry) => entry.entryName.endsWith(\"/app.manifest.json\"));\n  if (!manifestEntry) {\n    throw new Error(\"Manifest file not found in bundle\");\n  }\n  return new Promise((resolve, reject) => {\n    manifestEntry.getDataAsync((data, err) => {\n      if (err) {\n        return reject(new Error(\"Failed to read manifest file\", { cause: err }));\n      }\n      try {\n        console.log(JSON.parse(String(data)));\n        return resolve(JSON.parse(String(data)));\n      } catch (error) {\n        reject(new Error(\"Failed to parse manifest file\", { cause: error }));\n      }\n    });\n  });\n};\n\nconst isDirectExecution =\n  process.argv[1] && path.resolve(process.argv[1]) === fileURLToPath(import.meta.url);\n\nif (isDirectExecution) {\n  try {\n    const zipPath = process.env.INPUT_ARTIFACT || core.getInput(\"artifact\");\n    const bundle = new AdmZip(zipPath);\n\n    loadManifest(bundle)\n      .then((manifest) => console.log(manifest))\n      .catch((error) => console.error(error));\n  } catch (error: unknown) {\n    const message = error instanceof Error ? error.message : \"Unknown error\";\n    console.error(`Failed to load manifest: ${message}`);\n    throw error;\n  }\n}\n"],"names":["path","core.getInput"],"mappings":";;;;AAoBO,MAAM,eAAe,CAAC,WAAsC;AACjE,QAAM,gBACJ,OAAO,SAAS,mBAAmB,KACnC,OAAO,WAAA,EAAa,KAAK,CAAC,UAAU,MAAM,UAAU,SAAS,oBAAoB,CAAC;AACpF,MAAI,CAAC,eAAe;AAClB,UAAM,IAAI,MAAM,mCAAmC;AAAA,EACrD;AACA,SAAO,IAAI,QAAQ,CAAC,SAAS,WAAW;AACtC,kBAAc,aAAa,CAAC,MAAM,QAAQ;AACxC,UAAI,KAAK;AACP,eAAO,OAAO,IAAI,MAAM,gCAAgC,EAAE,OAAO,IAAA,CAAK,CAAC;AAAA,MACzE;AACA,UAAI;AACF,gBAAQ,IAAI,KAAK,MAAM,OAAO,IAAI,CAAC,CAAC;AACpC,eAAO,QAAQ,KAAK,MAAM,OAAO,IAAI,CAAC,CAAC;AAAA,MACzC,SAAS,OAAO;AACd,eAAO,IAAI,MAAM,iCAAiC,EAAE,OAAO,MAAA,CAAO,CAAC;AAAA,MACrE;AAAA,IACF,CAAC;AAAA,EACH,CAAC;AACH;AAEA,MAAM,oBACJ,QAAQ,KAAK,CAAC,KAAKA,cAAK,QAAQ,QAAQ,KAAK,CAAC,CAAC,MAAM,cAAc,YAAY,GAAG;AAEpF,IAAI,mBAAmB;AACrB,MAAI;AACF,UAAM,UAAU,QAAQ,IAAI,kBAAkBC,YAAAA,SAAc,UAAU;AACtE,UAAM,SAAS,IAAI,OAAO,OAAO;AAEjC,iBAAa,MAAM,EAChB,KAAK,CAAC,aAAa,QAAQ,IAAI,QAAQ,CAAC,EACxC,MAAM,CAAC,UAAU,QAAQ,MAAM,KAAK,CAAC;AAAA,EAC1C,SAAS,OAAgB;AACvB,UAAM,UAAU,iBAAiB,QAAQ,MAAM,UAAU;AACzD,YAAQ,MAAM,4BAA4B,OAAO,EAAE;AACnD,UAAM;AAAA,EACR;AACF;"}