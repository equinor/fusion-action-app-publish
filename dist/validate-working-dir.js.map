{"version":3,"file":"validate-working-dir.js","sources":["../src/core/validate-working-dir.ts"],"sourcesContent":["import * as fs from \"node:fs\";\nimport * as path from \"node:path\";\nimport { fileURLToPath } from \"node:url\";\nimport * as core from \"@actions/core\";\nimport type { FusionApp, PackageJson } from \"../types/fusion-app\";\n\ntype FusionAppResult = {\n  app?: FusionApp;\n  isValid: boolean;\n};\n\n/**\n * Searches for a Fusion application in the specified working directory.\n *\n * @param workingDirectory - The directory to search for the Fusion app.\n * @returns An object containing the Fusion app metadata and validity status.\n */\nexport function findFusionApp(workingDirectory: string): FusionAppResult {\n  const data = { app: undefined, isValid: false } as FusionAppResult;\n\n  try {\n    const packageJsonPath = path.join(workingDirectory, \"package.json\");\n    if (fs.existsSync(packageJsonPath)) {\n      try {\n        const packageJson = JSON.parse(fs.readFileSync(packageJsonPath, \"utf8\")) as PackageJson;\n        const appName = packageJson.name;\n        const version = packageJson.version;\n\n        if (isFusionApp(packageJson)) {\n          data.app = {\n            name: appName || \"unknown\",\n            path: workingDirectory,\n            version: version,\n          };\n          data.isValid = true;\n        }\n      } catch (parseError) {\n        core.warning(\n          `⚠️ Could not parse ${packageJsonPath}: ${parseError instanceof Error ? parseError.message : String(parseError)}`,\n        );\n      }\n    }\n  } catch (patternError) {\n    core.warning(\n      `⚠️ Pattern ${workingDirectory} failed: ${patternError instanceof Error ? patternError.message : String(patternError)}`,\n    );\n  }\n\n  return data;\n}\n\n/**\n * Determines if the provided package.json represents a Fusion application.\n *\n * @param packageJson - The package.json content as an object.\n * @returns True if it's a Fusion app, false otherwise.\n */\nexport function isFusionApp(packageJson: PackageJson): boolean {\n  const allDeps = {\n    ...packageJson.dependencies,\n    ...packageJson.devDependencies,\n  };\n\n  // Must have Fusion dependencies\n  const fusionDeps = Object.keys(allDeps).filter((dep) => dep.startsWith(\"@equinor/fusion\"));\n  const hasFusionDeps = fusionDeps.length > 0;\n\n  if (!hasFusionDeps) return false;\n\n  // Strong indicators it's an app\n  const hasCli = !!allDeps[\"@equinor/fusion-framework-cli\"];\n  const hasReactApp = !!allDeps[\"@equinor/fusion-framework-react-app\"];\n\n  if (hasCli || hasReactApp) return true;\n\n  const scripts = packageJson.scripts || {};\n  const hasAppScripts = Object.keys(scripts).some(\n    (script) =>\n      (scripts[script] || \"\").includes(\"fusion-framework-cli app\") ||\n      (scripts[script] || \"\").includes(\"ffc app\"),\n  );\n\n  const hasAppConfig = !!(packageJson.fusion || packageJson.fusionApp);\n\n  return hasCli || hasReactApp || hasAppScripts || hasAppConfig;\n}\n\nexport function testIsFusionApp() {\n  const workingDirectory = core.getInput(\"working-directory\") || \".\";\n  const result = findFusionApp(workingDirectory);\n\n  if (result.isValid && result.app) {\n    core.info(\n      `✅ Found Fusion app: ${result.app.name} at ${result.app.path} (version: ${result.app.version || \"N/A\"})`,\n    );\n  } else {\n    core.error(`❌ No valid Fusion app found in directory: ${workingDirectory}`);\n  }\n}\n\n// Execute if called directly\nconst isDirectExecution =\n  process.argv[1] && path.resolve(process.argv[1]) === fileURLToPath(import.meta.url);\n\nif (isDirectExecution) {\n  testIsFusionApp();\n}\n"],"names":["core.warning","core.getInput","core.info","core.error"],"mappings":";;;;AAiBO,SAAS,cAAc,kBAA2C;AACvE,QAAM,OAAO,EAAE,KAAK,QAAW,SAAS,MAAA;AAExC,MAAI;AACF,UAAM,kBAAkB,KAAK,KAAK,kBAAkB,cAAc;AAClE,QAAI,GAAG,WAAW,eAAe,GAAG;AAClC,UAAI;AACF,cAAM,cAAc,KAAK,MAAM,GAAG,aAAa,iBAAiB,MAAM,CAAC;AACvE,cAAM,UAAU,YAAY;AAC5B,cAAM,UAAU,YAAY;AAE5B,YAAI,YAAY,WAAW,GAAG;AAC5B,eAAK,MAAM;AAAA,YACT,MAAM,WAAW;AAAA,YACjB,MAAM;AAAA,YACN;AAAA,UAAA;AAEF,eAAK,UAAU;AAAA,QACjB;AAAA,MACF,SAAS,YAAY;AACnBA,oBAAAA;AAAAA,UACE,sBAAsB,eAAe,KAAK,sBAAsB,QAAQ,WAAW,UAAU,OAAO,UAAU,CAAC;AAAA,QAAA;AAAA,MAEnH;AAAA,IACF;AAAA,EACF,SAAS,cAAc;AACrBA,gBAAAA;AAAAA,MACE,cAAc,gBAAgB,YAAY,wBAAwB,QAAQ,aAAa,UAAU,OAAO,YAAY,CAAC;AAAA,IAAA;AAAA,EAEzH;AAEA,SAAO;AACT;AAQO,SAAS,YAAY,aAAmC;AAC7D,QAAM,UAAU;AAAA,IACd,GAAG,YAAY;AAAA,IACf,GAAG,YAAY;AAAA,EAAA;AAIjB,QAAM,aAAa,OAAO,KAAK,OAAO,EAAE,OAAO,CAAC,QAAQ,IAAI,WAAW,iBAAiB,CAAC;AACzF,QAAM,gBAAgB,WAAW,SAAS;AAE1C,MAAI,CAAC,cAAe,QAAO;AAG3B,QAAM,SAAS,CAAC,CAAC,QAAQ,+BAA+B;AACxD,QAAM,cAAc,CAAC,CAAC,QAAQ,qCAAqC;AAEnE,MAAI,UAAU,YAAa,QAAO;AAElC,QAAM,UAAU,YAAY,WAAW,CAAA;AACvC,QAAM,gBAAgB,OAAO,KAAK,OAAO,EAAE;AAAA,IACzC,CAAC,YACE,QAAQ,MAAM,KAAK,IAAI,SAAS,0BAA0B,MAC1D,QAAQ,MAAM,KAAK,IAAI,SAAS,SAAS;AAAA,EAAA;AAG9C,QAAM,eAAe,CAAC,EAAE,YAAY,UAAU,YAAY;AAE1D,SAAO,UAAU,eAAe,iBAAiB;AACnD;AAEO,SAAS,kBAAkB;AAChC,QAAM,mBAAmBC,YAAAA,SAAc,mBAAmB,KAAK;AAC/D,QAAM,SAAS,cAAc,gBAAgB;AAE7C,MAAI,OAAO,WAAW,OAAO,KAAK;AAChCC,gBAAAA;AAAAA,MACE,uBAAuB,OAAO,IAAI,IAAI,OAAO,OAAO,IAAI,IAAI,cAAc,OAAO,IAAI,WAAW,KAAK;AAAA,IAAA;AAAA,EAEzG,OAAO;AACLC,gBAAAA,MAAW,6CAA6C,gBAAgB,EAAE;AAAA,EAC5E;AACF;AAGA,MAAM,oBACJ,QAAQ,KAAK,CAAC,KAAK,KAAK,QAAQ,QAAQ,KAAK,CAAC,CAAC,MAAM,cAAc,YAAY,GAAG;AAEpF,IAAI,mBAAmB;AACrB,kBAAA;AACF;"}