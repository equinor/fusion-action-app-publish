{"version":3,"file":"post-publish-metadata.cjs","sources":["../src/core/post-publish-metadata.ts"],"sourcesContent":["/**\n * post-publish-metadata.ts\n * Posts metadata about the published application for the GitHub Action\n * Used as part of GitHub Action workflows to provide publish information\n */\n\nimport { exec as execCallback } from \"node:child_process\";\nimport * as fs from \"node:fs\";\nimport * as path from \"node:path\";\nimport { promisify } from \"node:util\";\n\nimport * as core from \"@actions/core\";\nimport * as github from \"@actions/github\";\n\nimport type { AppMetadata, ExecResult } from \"../types/metadata\";\n\nconst exec = promisify(execCallback);\n\n/**\n * Extracts app metadata from the artifact\n * Uses `unzip -p` to read the metadata directly from the zip file\n * without extracting to temporary files for better performance and security\n * @param artifactPath - Path to the artifact\n * @returns Parsed app metadata with mapped fields\n */\nexport async function extractAppMetadata(artifactPath: string): Promise<AppMetadata> {\n  try {\n    const artifactExtension = path.extname(artifactPath).toLowerCase();\n    if (artifactExtension !== \".zip\") {\n      throw new Error(\n        `Unsupported artifact format: ${artifactExtension}. Only .zip files are supported.`,\n      );\n    }\n\n    const { stdout, stderr }: ExecResult = await exec(\n      `unzip -p \"${artifactPath}\" \"*/metadata.json\"`,\n    );\n\n    if (stderr) {\n      core.warning(`Warning from unzip: ${stderr}`);\n    }\n\n    const metadataContent = stdout.trim();\n    if (!metadataContent) {\n      throw new Error(\"metadata.json not found in artifact\");\n    }\n\n    try {\n      const metadata: AppMetadata = JSON.parse(metadataContent);\n      metadata.key = metadata.name;\n      return metadata;\n    } catch (parseError: unknown) {\n      const message = parseError instanceof Error ? parseError.message : \"Unknown parse error\";\n      throw new Error(`Invalid JSON format in metadata.json: ${message}`);\n    }\n  } catch (error: unknown) {\n    const message = error instanceof Error ? error.message : \"Unknown error\";\n    core.error(`Failed to extract app metadata: ${message}`);\n    throw error;\n  }\n}\n\n/**\n * Generates application URL based on environment and app info\n * \n * URLs are constructed based on the environment:\n * - ci: https://fusion.ci.fusion-dev.net\n * - fqa: https://fusion.fqa.fusion-dev.net\n * - fprd: https://fusion.equinor.com (production)\n * - tr: https://fusion.tr.fusion-dev.net\n * - next: https://fusion.next.fusion-dev.net\n * \n * For non-latest tags, includes tag as query parameter for version tracking\n * \n * @param meta - App metadata containing application key\n * @param env - Deployment environment (ci, fqa, fprd, tr, next)\n * @param tag - Deployment tag/version identifier\n * @returns Full application URL to access the deployed application\nn * @throws Error if app key is not found in metadata\n * @example\n * const url = generateAppUrl(meta, 'fprd', 'v1.0.0');\n * // Returns: https://fusion.equinor.com/apps/my-app?$tag=v1.0.0\n */\nexport function generateAppUrl(meta: AppMetadata, env: string, tag: string): string {\n  const appKey = meta.key;\n\n  if (!appKey) {\n    throw new Error(\"App key not found in metadata\");\n  }\n\n  // Environment-specific Fusion portal base URLs\n  const envUrls: Record<string, string> = {\n    ci: \"https://fusion.ci.fusion-dev.net\",\n    fqa: \"https://fusion.fqa.fusion-dev.net\",\n    fprd: \"https://fusion.equinor.com\",\n    tr: \"https://fusion.tr.fusion-dev.net\",\n    next: \"https://fusion.next.fusion-dev.net\",\n  };\n\n  const baseUrl = envUrls[env] || envUrls.fprd;\n\n  // Construct application URL\n  if (!tag.startsWith(\"latest\")) {\n    return `${baseUrl}/apps/${appKey}?$tag=${tag}`;\n  }\n\n  return `${baseUrl}/apps/${appKey}`;\n}\n\n/**\\n * Posts a comment to the PR with the application URL and deployment info\\n * \\n * This function:\\n * - Checks for GITHUB_TOKEN availability (required for posting comments)\\n * - Detects PR number from GitHub context or tag (for pr-{number} format)\\n * - Creates a formatted Markdown comment with:\\n *   - Application name, version, environment, tag\\n *   - Direct links to the deployed application\\n *   - Fusion App Admin panel for management\\n *   - Deployment metadata for tracking\\n * - Uses meta comment identifier to allow checking for existing comments\\n * \\n * If not in a PR context (no PR number available), this function silently returns\\n * without posting.\\n * \\n * @param meta - App metadata object\\n * @param env - Deployment environment\\n * @param tag - Deployment tag/version\\n * @param appUrl - Generated application URL\\n * @param appAdminUrl - Generated app admin panel URL\\n * @throws Does not throw, but logs warnings on failure\\n */\nexport async function postPrComment(\n  meta: AppMetadata,\n  env: string,\n  tag: string,\n  appUrl: string,\n  appAdminUrl: string,\n): Promise<void> {\n  try {\n    const token = process.env.GITHUB_TOKEN;\n    if (!token) {\n      core.info(\"GITHUB_TOKEN not available, skipping PR comment\");\n      return;\n    }\n\n    const octokit = github.getOctokit(token);\n    const context = github.context;\n\n    // Only post comment for PR events or when PR number is available\n    const prNumber =\n      context.payload.pull_request?.number ||\n      (tag?.startsWith(\"pr-\") ? parseInt(tag.replace(\"pr-\", \"\"), 10) : null);\n\n    if (!prNumber) {\n      core.info(\"Not a PR deployment, skipping PR comment\");\n      return;\n    }\n\n    const appName = meta.name;\n    const appVersion = meta.version || \"unknown\";\n    const appDescription = meta.description || \"\";\n\n    // Create formatted comment with deployment details\n    const commentBody = `<!-- fusion-app-publish-meta -->\n## ðŸš€ Application Deployed Successfully\n\n  **Application:** ${appName}  \n  **Version:** ${appVersion}  \n  **Environment:** ${env.toUpperCase()}  \n  **Tag:** ${tag}  \n\n  ${appDescription ? `**Description:** ${appDescription}\\n\\n` : \"\"}\n\n  ### ðŸ”— Access Links\n  - **Application:** [Open ${appName}](${appUrl})\n  - **Fusion App Admin:** [Manage in Fusion App Admin](${appAdminUrl})\n  - **App Config:** [View app config](${appAdminUrl}/config)\n\n  ### ðŸ“‹ Deployment Details\n  - **App Key:** \\`${meta.key}\\`\n  - **Bundle:** ${meta.entry?.path || \"Not specified\"}\n  - **Build Time:** ${new Date().toISOString()}\n\n  ---\n  *Deployed via [fusion-action-app-publish](https://github.com/equinor/fusion-action-app-publish)*`;\n\n    await octokit.rest.issues.createComment({\n      owner: context.repo.owner,\n      repo: context.repo.repo,\n      issue_number: prNumber,\n      body: commentBody,\n    });\n\n    core.info(`Posted deployment comment to PR #${prNumber}`);\n  } catch (error: unknown) {\n    const message = error instanceof Error ? error.message : \"Unknown error\";\n    core.warning(`Failed to post PR comment: ${message}`);\n  }\n}\n\n/**\n * Main function to extract metadata and post publish information\n *\n * This is the primary orchestration function that:\n * 1. Reads GitHub Action inputs (artifact, environment, tag, working directory)\n * 2. Resolves the artifact file path\n * 3. Extracts application metadata from the artifact's metadata.json\n * 4. Generates application URLs for different contexts\n * 5. Sets GitHub Action outputs for downstream steps:\n *    - app-name: Application name from metadata\n *    - app-version: Application semantic version\n *    - app-key: Application unique identifier\n *    - app-url: URL to access deployed application\n *    - app-admin-url: URL to access app admin panel\n *    - publish-info: Formatted summary for notifications\n * 6. Posts deployment comment to PR (if applicable)\n *\n * This function is typically called directly as the entry point when the module\n * is executed in a GitHub Action workflow.\n *\n * @throws Does not throw, but calls core.setFailed() on errors\n */\nexport async function postPublishMetadata(): Promise<void> {\n  try {\n    const artifact = core.getInput(\"artifact\");\n    const env = core.getInput(\"env\");\n    const tag = core.getInput(\"tag\");\n    const workingDirectory = core.getInput(\"working-directory\") || \".\";\n\n    core.info(`Processing artifact: ${artifact}`);\n    core.info(`Environment: ${env}`);\n    core.info(`Tag: ${tag}`);\n\n    // Resolve artifact path\n    const artifactPath = path.resolve(workingDirectory, artifact);\n\n    if (!fs.existsSync(artifactPath)) {\n      throw new Error(`Artifact not found: ${artifactPath}`);\n    }\n\n    // Extract app metadata from artifact\n    const meta = await extractAppMetadata(artifactPath);\n\n    const appName = meta.name;\n    const appVersion = meta.version || \"unknown\";\n    const appKey = meta.key;\n\n    core.info(`App Name: ${appName}`);\n    core.info(`App Version: ${appVersion}`);\n    core.info(`App Key: ${appKey}`);\n\n    // Generate application URL\n    const appUrl = generateAppUrl(meta, env, tag);\n    core.info(`App URL: ${appUrl}`);\n\n    // Set outputs for use in other steps\n    core.setOutput(\"app-name\", appName);\n    core.setOutput(\"app-version\", appVersion);\n    core.setOutput(\"app-key\", appKey);\n    core.setOutput(\"app-url\", appUrl);\n\n    // Generate app admin URL\n    const appAdminBaseUrl = appUrl.split(\"/apps/\")[0];\n    const appAdminUrl = `${appAdminBaseUrl}/apps/app-admin/apps/${appKey}`;\n    core.setOutput(\"app-admin-url\", appAdminUrl);\n\n    // Create formatted publish info for PR comments\n    const publishInfo = `ðŸš€ **${appName}** v${appVersion} deployed to **${env.toUpperCase()}**\\n[Open Application](${appUrl})`;\n    core.setOutput(\"publish-info\", publishInfo);\n\n    // Post comment to PR if applicable\n    await postPrComment(meta, env, tag, appUrl, appAdminUrl);\n\n    core.info(\"Post-publish metadata processing completed successfully\");\n  } catch (error: unknown) {\n    const message = error instanceof Error ? error.message : \"Unknown error\";\n    core.setFailed(`Post-publish metadata failed: ${message}`);\n  }\n}\n\n// Execute if called directly\nif (require.main === module) {\n  postPublishMetadata();\n}\n"],"names":["promisify","execCallback","path","core.warning","core.error","core.info","github.getOctokit","github.context","core.getInput","fs","core.setOutput","core.setFailed"],"mappings":"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"}