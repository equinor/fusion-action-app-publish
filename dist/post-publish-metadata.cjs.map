{"version":3,"file":"post-publish-metadata.cjs","sources":["../src/core/post-publish-metadata.ts"],"sourcesContent":["/**\n * post-publish-metadata.ts\n * Posts metadata about the published application for the GitHub Action\n * Used as part of GitHub Action workflows to provide publish information\n */\n\nimport * as core from '@actions/core';\nimport * as github from '@actions/github';\nimport * as fs from 'node:fs';\nimport * as path from 'node:path';\nimport { promisify } from 'node:util';\nimport { exec as execCallback } from 'node:child_process';\nimport type { AppMetadata, ExecResult } from '../types/metadata';\n\nconst exec = promisify(execCallback);\n\n/**\n * Extracts app metadata from the artifact\n * Uses `unzip -p` to read the metadata directly from the zip file\n * without extracting to temporary files for better performance and security\n * @param artifactPath - Path to the artifact\n * @returns Parsed app metadata with mapped fields\n */\nexport async function extractAppMetadata(artifactPath: string): Promise<AppMetadata> {\n  try {\n    // Only zip format supported for now\n    const artifactExtension = path.extname(artifactPath).toLowerCase();\n    \n    if (artifactExtension !== '.zip') {\n      throw new Error(`Unsupported artifact format: ${artifactExtension}. Only .zip files are supported.`);\n    }\n\n    // Read metadata.json directly from zip without extracting\n    const { stdout, stderr }: ExecResult = await exec(`unzip -p \"${artifactPath}\" \"*/metadata.json\"`);\n    \n    if (stderr) {\n      core.warning(`Warning from unzip: ${stderr}`);\n    }\n\n    const metadataContent = stdout.trim();\n    \n    if (!metadataContent) {\n      throw new Error('metadata.json not found in artifact');\n    }\n\n    try {\n      const metadata: AppMetadata = JSON.parse(metadataContent);\n      \n      // Add key field using name for app identification\n      metadata.key = metadata.name;\n      \n      return metadata;\n    } catch (parseError: any) {\n      throw new Error(`Invalid JSON format in metadata.json: ${parseError.message}`);\n    }\n\n  } catch (error: any) {\n    core.error(`Failed to extract app metadata: ${error.message}`);\n    throw error;\n  }\n}\n\n/**\n * Generates application URL based on environment and app info\n * @param meta - App metadata object\n * @param env - Environment (ci, fqa, fprd, tr, next)\n * @param tag - Deployment tag\n * @returns Application URL\n */\nexport function generateAppUrl(meta: AppMetadata, env: string, tag: string): string {\n  const appKey = meta.key;\n  \n  if (!appKey) {\n    throw new Error('App key not found in metadata');\n  }\n\n  // Environment-specific Fusion portal base URLs\n  const envUrls: Record<string, string> = {\n    'ci': 'https://fusion.ci.fusion-dev.net',\n    'fqa': 'https://fusion.fqa.fusion-dev.net', \n    'fprd': 'https://fusion.equinor.com',\n    'tr': 'https://fusion.tr.fusion-dev.net',\n    'next': 'https://fusion.next.fusion-dev.net'\n  };\n\n  const baseUrl = envUrls[env] || envUrls['fprd'];\n  \n  // Construct application URL\n  if (!tag.startsWith('latest')) {\n    return `${baseUrl}/apps/${appKey}?$tag=${tag}`;\n  }\n  \n  return `${baseUrl}/apps/${appKey}`;\n}\n\n/**\n * Posts a comment to the PR with the application URL and deployment info\n * @param meta - App metadata object\n * @param env - Environment\n * @param tag - Deployment tag\n * @param appUrl - Application URL\n * @param appAdminUrl - Application Admin URL\n */\nexport async function postPrComment(\n  meta: AppMetadata,\n  env: string,\n  tag: string,\n  appUrl: string,\n  appAdminUrl: string\n): Promise<void> {\n  try {\n    const token = process.env.GITHUB_TOKEN;\n    if (!token) {\n      core.info('GITHUB_TOKEN not available, skipping PR comment');\n      return;\n    }\n\n    const octokit = github.getOctokit(token);\n    const context = github.context;\n\n    // Only post comment for PR events or when PR number is available\n    const prNumber = context.payload.pull_request?.number || \n                    (tag && tag.startsWith('pr-') ? parseInt(tag.replace('pr-', '')) : null);\n\n    if (!prNumber) {\n      core.info('Not a PR deployment, skipping PR comment');\n      return;\n    }\n\n    const appName = meta.name;\n    const appVersion = meta.version || 'unknown';\n    const appDescription = meta.description || '';\n\n    // Create formatted comment with deployment details\n    const commentBody = `## ðŸš€ Application Deployed Successfully\n\n**Application:** ${appName}  \n**Version:** ${appVersion}  \n**Environment:** ${env.toUpperCase()}  \n**Tag:** ${tag}  \n\n${appDescription ? `**Description:** ${appDescription}\\n\\n` : ''}\n\n### ðŸ”— Access Links\n- **Application:** [Open ${appName}](${appUrl})\n- **Fusion App Admin:** [Manage in Fusion App Admin](${appAdminUrl})\n- **App Config:** [View app config](${appAdminUrl}/config)\n\n### ðŸ“‹ Deployment Details\n- **App Key:** \\`${meta.key}\\`\n- **Bundle:** ${meta.entry?.path || 'Not specified'}\n- **Build Time:** ${new Date().toISOString()}\n\n---\n*Deployed via [fusion-action-app-publish](https://github.com/equinor/fusion-action-app-publish)*`;\n\n    await octokit.rest.issues.createComment({\n      owner: context.repo.owner,\n      repo: context.repo.repo,\n      issue_number: prNumber,\n      body: commentBody\n    });\n\n    core.info(`Posted deployment comment to PR #${prNumber}`);\n  } catch (error: any) {\n    core.warning(`Failed to post PR comment: ${error.message}`);\n  }\n}\n\n/**\n * Main function to extract metadata and post publish information\n */\nexport async function postPublishMetadata(): Promise<void> {\n  try {\n    const artifact = core.getInput('artifact');\n    const env = core.getInput('env');\n    const tag = core.getInput('tag');\n    const workingDirectory = core.getInput('working-directory') || '.';\n\n    core.info(`Processing artifact: ${artifact}`);\n    core.info(`Environment: ${env}`);\n    core.info(`Tag: ${tag}`);\n\n    // Resolve artifact path\n    const artifactPath = path.resolve(workingDirectory, artifact);\n    \n    if (!fs.existsSync(artifactPath)) {\n      throw new Error(`Artifact not found: ${artifactPath}`);\n    }\n\n    // Extract app metadata from artifact\n    const meta = await extractAppMetadata(artifactPath);\n    \n    const appName = meta.name;\n    const appVersion = meta.version || 'unknown';\n    const appKey = meta.key;\n\n    core.info(`App Name: ${appName}`);\n    core.info(`App Version: ${appVersion}`);\n    core.info(`App Key: ${appKey}`);\n\n    // Generate application URL\n    const appUrl = generateAppUrl(meta, env, tag);\n    core.info(`App URL: ${appUrl}`);\n\n    // Set outputs for use in other steps\n    core.setOutput('app-name', appName);\n    core.setOutput('app-version', appVersion);\n    core.setOutput('app-key', appKey);\n    core.setOutput('app-url', appUrl);\n\n    // Generate app admin URL\n    const appAdminBaseUrl = appUrl.split('/apps/')[0];\n    const appAdminUrl = `${appAdminBaseUrl}/apps/app-admin/apps/${appKey}`;\n    core.setOutput('app-admin-url', appAdminUrl);\n\n    // Create formatted publish info for PR comments\n    const publishInfo = `ðŸš€ **${appName}** v${appVersion} deployed to **${env.toUpperCase()}**\\n[Open Application](${appUrl})`;\n    core.setOutput('publish-info', publishInfo);\n\n    // Post comment to PR if applicable\n    await postPrComment(meta, env, tag, appUrl, appAdminUrl);\n\n    core.info('Post-publish metadata processing completed successfully');\n\n  } catch (error: any) {\n    core.setFailed(`Post-publish metadata failed: ${error.message}`);\n  }\n}\n\n// Execute if called directly\nif (require.main === module) {\n  postPublishMetadata();\n}\n"],"names":["promisify","execCallback","path","core","github","fs"],"mappings":"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"}