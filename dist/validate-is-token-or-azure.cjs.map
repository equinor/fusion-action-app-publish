{"version":3,"file":"validate-is-token-or-azure.cjs","sources":["../src/core/validate-is-token-or-azure.ts"],"sourcesContent":["/**\n * validate-is-token-or-azure.ts\n * Validates the token or Azure credentials input for the GitHub Action\n * Used as part of GitHub Action workflows to ensure correct authentication is provided\n */\n\nimport * as core from \"@actions/core\";\nimport type { AuthDetectionResult, AuthType, Credentials, ValidationResult } from \"../types/auth\";\n\n// Authentication types enum\nexport const AUTH_TYPES = {\n  TOKEN: \"token\",\n  SERVICE_PRINCIPAL: \"service-principal\",\n} as const satisfies Record<string, AuthType>;\n\n/**\n * Validates fusion token format and structure\n * @param token - The fusion token to validate\n * @returns Validation result with isValid boolean and error message if any\n */\nexport function validateFusionToken(token: string): ValidationResult {\n  // Validate that the fusion-token is a non-empty string\n  if (!token || typeof token !== \"string\" || token.trim() === \"\") {\n    return {\n      isValid: false,\n      error: \"Input 'fusion-token' must be a non-empty string.\",\n    };\n  }\n\n  // Validate the format of the fusion-token\n  const tokenPattern = /^BEARER [A-Za-z0-9._-]+$/;\n  if (!tokenPattern.test(token)) {\n    return {\n      isValid: false,\n      error:\n        \"Input 'fusion-token' is not in the correct format. It should start with 'BEARER ' followed by valid token characters.\",\n    };\n  }\n\n  return {\n    isValid: true,\n    error: null,\n  };\n}\n\n/**\n * Detects authentication type and validates Service Principal credentials\n * @param credentials - Object containing all credential inputs\n * @returns Detection result with authType, isValid boolean, and error message if any\n */\nexport function detectAndValidateAuthType(credentials: Credentials): AuthDetectionResult {\n  const { fusionToken, azureClientId, azureTenantId, azureResourceId } = credentials;\n\n  // Check if Azure Service Principal credentials are provided\n  const hasAzureCredentials = azureClientId && azureTenantId && azureResourceId;\n  const hasPartialAzureCredentials = azureClientId || azureTenantId || azureResourceId;\n\n  // If we have both token and Azure credentials\n  if (fusionToken && hasAzureCredentials) {\n    // Prefer Service Principal when both are provided\n    core.info(\"Both token and Azure credentials provided. Using Service Principal authentication.\");\n    return {\n      authType: AUTH_TYPES.SERVICE_PRINCIPAL,\n      isValid: true,\n      error: null,\n    };\n  }\n\n  // If we have a token and no Azure credentials\n  if (fusionToken && !hasPartialAzureCredentials) {\n    return {\n      authType: AUTH_TYPES.TOKEN,\n      isValid: true,\n      error: null,\n    };\n  }\n\n  // If we have all Azure credentials\n  if (hasAzureCredentials) {\n    return {\n      authType: AUTH_TYPES.SERVICE_PRINCIPAL,\n      isValid: true,\n      error: null,\n    };\n  }\n\n  // If we have partial Azure credentials (invalid state)\n  if (hasPartialAzureCredentials && !hasAzureCredentials) {\n    return {\n      authType: null,\n      isValid: false,\n      error:\n        \"All Azure credentials ('azure-client-id', 'azure-tenant-id', 'azure-resource-id') must be provided when using Service Principal authentication.\",\n    };\n  }\n\n  // No valid credentials provided\n  return {\n    authType: null,\n    isValid: false,\n    error:\n      \"Either 'fusion-token' or all Azure credentials ('azure-client-id', 'azure-tenant-id', 'azure-resource-id') must be provided.\",\n  };\n}\n\n/**\n * Main function to validate the authentication inputs\n */\nexport function validateIsTokenOrAzure(): void {\n  // Get all authentication inputs from GitHub Action\n  const credentials: Credentials = {\n    fusionToken: core.getInput(\"fusion-token\"),\n    azureClientId: core.getInput(\"azure-client-id\"),\n    azureTenantId: core.getInput(\"azure-tenant-id\"),\n    azureResourceId: core.getInput(\"azure-resource-id\"),\n  };\n\n  // Detect authentication type and validate credentials\n  const authResult = detectAndValidateAuthType(credentials);\n\n  if (!authResult.isValid) {\n    const message = authResult.error ?? \"Authentication validation failed.\";\n    core.setFailed(message);\n    return;\n  }\n\n  // Set outputs for authentication type information\n  core.setOutput(\"auth-type\", authResult.authType);\n  core.setOutput(\"isToken\", authResult.authType === AUTH_TYPES.TOKEN);\n  core.setOutput(\"isServicePrincipal\", authResult.authType === AUTH_TYPES.SERVICE_PRINCIPAL);\n\n  // If using token authentication, validate the token format\n  if (authResult.authType === AUTH_TYPES.TOKEN) {\n    const tokenValidation = validateFusionToken(credentials.fusionToken);\n\n    if (!tokenValidation.isValid) {\n      const message = tokenValidation.error ?? \"Invalid fusion token.\";\n      core.setFailed(message);\n      return;\n    }\n\n    core.info(\"Fusion token validation passed.\");\n  } else if (authResult.authType === AUTH_TYPES.SERVICE_PRINCIPAL) {\n    core.info(\"Azure Service Principal credentials validated.\");\n  }\n}\n\n// Execute if called directly\nif (require.main === module) {\n  validateIsTokenOrAzure();\n}\n"],"names":["core"],"mappings":";;;;;;;;;;;;;;;;;;;;;AAUO,MAAM,aAAa;AAAA,EACxB,OAAO;AAAA,EACP,mBAAmB;AACrB;AAOO,SAAS,oBAAoB,OAAiC;AAEnE,MAAI,CAAC,SAAS,OAAO,UAAU,YAAY,MAAM,KAAA,MAAW,IAAI;AAC9D,WAAO;AAAA,MACL,SAAS;AAAA,MACT,OAAO;AAAA,IAAA;AAAA,EAEX;AAGA,QAAM,eAAe;AACrB,MAAI,CAAC,aAAa,KAAK,KAAK,GAAG;AAC7B,WAAO;AAAA,MACL,SAAS;AAAA,MACT,OACE;AAAA,IAAA;AAAA,EAEN;AAEA,SAAO;AAAA,IACL,SAAS;AAAA,IACT,OAAO;AAAA,EAAA;AAEX;AAOO,SAAS,0BAA0B,aAA+C;AACvF,QAAM,EAAE,aAAa,eAAe,eAAe,oBAAoB;AAGvE,QAAM,sBAAsB,iBAAiB,iBAAiB;AAC9D,QAAM,6BAA6B,iBAAiB,iBAAiB;AAGrE,MAAI,eAAe,qBAAqB;AAEtCA,oBAAK,KAAK,oFAAoF;AAC9F,WAAO;AAAA,MACL,UAAU,WAAW;AAAA,MACrB,SAAS;AAAA,MACT,OAAO;AAAA,IAAA;AAAA,EAEX;AAGA,MAAI,eAAe,CAAC,4BAA4B;AAC9C,WAAO;AAAA,MACL,UAAU,WAAW;AAAA,MACrB,SAAS;AAAA,MACT,OAAO;AAAA,IAAA;AAAA,EAEX;AAGA,MAAI,qBAAqB;AACvB,WAAO;AAAA,MACL,UAAU,WAAW;AAAA,MACrB,SAAS;AAAA,MACT,OAAO;AAAA,IAAA;AAAA,EAEX;AAGA,MAAI,8BAA8B,CAAC,qBAAqB;AACtD,WAAO;AAAA,MACL,UAAU;AAAA,MACV,SAAS;AAAA,MACT,OACE;AAAA,IAAA;AAAA,EAEN;AAGA,SAAO;AAAA,IACL,UAAU;AAAA,IACV,SAAS;AAAA,IACT,OACE;AAAA,EAAA;AAEN;AAKO,SAAS,yBAA+B;AAE7C,QAAM,cAA2B;AAAA,IAC/B,aAAaA,gBAAK,SAAS,cAAc;AAAA,IACzC,eAAeA,gBAAK,SAAS,iBAAiB;AAAA,IAC9C,eAAeA,gBAAK,SAAS,iBAAiB;AAAA,IAC9C,iBAAiBA,gBAAK,SAAS,mBAAmB;AAAA,EAAA;AAIpD,QAAM,aAAa,0BAA0B,WAAW;AAExD,MAAI,CAAC,WAAW,SAAS;AACvB,UAAM,UAAU,WAAW,SAAS;AACpCA,oBAAK,UAAU,OAAO;AACtB;AAAA,EACF;AAGAA,kBAAK,UAAU,aAAa,WAAW,QAAQ;AAC/CA,kBAAK,UAAU,WAAW,WAAW,aAAa,WAAW,KAAK;AAClEA,kBAAK,UAAU,sBAAsB,WAAW,aAAa,WAAW,iBAAiB;AAGzF,MAAI,WAAW,aAAa,WAAW,OAAO;AAC5C,UAAM,kBAAkB,oBAAoB,YAAY,WAAW;AAEnE,QAAI,CAAC,gBAAgB,SAAS;AAC5B,YAAM,UAAU,gBAAgB,SAAS;AACzCA,sBAAK,UAAU,OAAO;AACtB;AAAA,IACF;AAEAA,oBAAK,KAAK,iCAAiC;AAAA,EAC7C,WAAW,WAAW,aAAa,WAAW,mBAAmB;AAC/DA,oBAAK,KAAK,gDAAgD;AAAA,EAC5D;AACF;AAGA,IAAI,QAAQ,SAAS,QAAQ;AAC3B,yBAAA;AACF;;;;;"}