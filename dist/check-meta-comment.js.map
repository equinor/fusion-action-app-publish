{"version":3,"file":"check-meta-comment.js","sources":["../src/core/check-meta-comment.ts"],"sourcesContent":["/**\n * check-meta-comment.ts\n *\n * Checks if a meta comment already exists on the PR to avoid duplicate comments\n *\n * This module is used to detect existing deployment comments before posting a new one,\n * preventing duplicate comments when the action runs multiple times (e.g., on retries).\n *\n * Uses GitHub's Issues API to:\n * - List all comments on the PR\n * - Search for meta-comment identifier (HTML comment)\n * - Report existence back to caller\n *\n * This enables workflows to conditionally post comments:\n * - Skip posting if comment already exists\n * - Post fresh comment on first deployment\n */\nimport * as fs from \"node:fs\";\nimport * as path from \"node:path\";\nimport { fileURLToPath } from \"node:url\";\nimport * as core from \"@actions/core\";\nimport * as github from \"@actions/github\";\nimport { extractAppMetadata } from \"./extract-metadata\";\n\n/**\n * Checks if a meta comment already exists on the PR\n *\n * Detection:\n * - Requires GITHUB_TOKEN environment variable (for API access)\n * - Determines PR number from GitHub context or tag (pr-{number} format)\n * - Queries GitHub API for all comments on the issue\n * - Searches for meta-comment identifier: `<!-- fusion-app-publish-meta -->`\n *\n * Sets GitHub Action output:\n * - `exists`: 'true' if comment found, 'false' otherwise\n *\n * Gracefully handles:\n * - Missing GITHUB_TOKEN (returns false, logs info)\n * - Non-PR context (returns false, logs info)\n * - API errors (logs warning, returns false, continues)\n *\n * @returns Promise resolving to true if meta comment exists, false otherwise\n * @throws Only throws after calling core.setFailed() on unexpected errors\n * @example\n * const exists = await checkMetaComment();\n * if (!exists) {\n *   await postPrComment(meta, env, tag, appUrl, appAdminUrl);\n * }\n */\nexport async function checkMetaComment(): Promise<boolean> {\n  try {\n    const token = process.env.GITHUB_TOKEN;\n    if (!token) {\n      core.info(\"GITHUB_TOKEN not available\");\n      return false;\n    }\n\n    const context = github.context;\n    const tag = core.getInput(\"tag\");\n    const artifact = core.getInput(\"artifact\");\n    const workingDirectory = core.getInput(\"working-directory\") || \".\";\n    // Resolve artifact path\n    const artifactPath = path.resolve(workingDirectory, artifact);\n\n    if (!fs.existsSync(artifactPath)) {\n      throw new Error(`Artifact not found: ${artifactPath}`);\n    }\n\n    // Extract app metadata from artifact\n    const meta = await extractAppMetadata(artifactPath);\n    const appName = meta.name;\n\n    // Extract PR number from context or tag\n    const prNumber =\n      context.payload.pull_request?.number ||\n      (tag?.startsWith(\"pr-\") ? parseInt(tag.replace(\"pr-\", \"\"), 10) : null);\n\n    if (!prNumber) {\n      core.info(\"Not a PR deployment, no meta comment check needed\");\n      return false;\n    }\n\n    const octokit = github.getOctokit(token);\n\n    try {\n      const comments = await octokit.rest.issues.listComments({\n        owner: context.repo.owner,\n        repo: context.repo.repo,\n        issue_number: prNumber,\n      });\n\n      const exists = comments.data.some(\n        (comment) =>\n          comment.body?.includes(`### ðŸš€ ${tag.toLocaleUpperCase()} Deployed`) &&\n          comment.body?.includes(appName),\n      );\n\n      if (exists) {\n        core.info(`Meta comment already exists on PR #${prNumber}, will skip posting`);\n        core.setOutput(\"exists\", \"true\");\n      } else {\n        core.info(`No existing meta comment found on PR #${prNumber}`);\n        core.setOutput(\"exists\", \"false\");\n      }\n\n      return exists;\n    } catch (error: unknown) {\n      const message = error instanceof Error ? error.message : \"Unknown error\";\n      core.warning(`Failed to check for existing meta comment: ${message}`);\n      return false;\n    }\n  } catch (error: unknown) {\n    const message = error instanceof Error ? error.message : \"Unknown error\";\n    core.setFailed(`Check meta comment failed: ${message}`);\n    throw error;\n  }\n}\n\n// Execute if called directly\nconst isDirectExecution =\n  process.argv[1] && path.resolve(process.argv[1]) === fileURLToPath(import.meta.url);\n\nif (isDirectExecution) {\n  checkMetaComment();\n}\n"],"names":["core.info","context","github.context","core.getInput","github.getOctokit","core.setOutput","core.warning","core.setFailed"],"mappings":";;;;;;AAiDA,eAAsB,mBAAqC;AACzD,MAAI;AACF,UAAM,QAAQ,QAAQ,IAAI;AAC1B,QAAI,CAAC,OAAO;AACVA,WAAU,4BAA4B;AACtC,aAAO;AAAA,IACT;AAEA,UAAMC,YAAUC;AAChB,UAAM,MAAMC,SAAc,KAAK;AAC/B,UAAM,WAAWA,SAAc,UAAU;AACzC,UAAM,mBAAmBA,SAAc,mBAAmB,KAAK;AAE/D,UAAM,eAAe,KAAK,QAAQ,kBAAkB,QAAQ;AAE5D,QAAI,CAAC,GAAG,WAAW,YAAY,GAAG;AAChC,YAAM,IAAI,MAAM,uBAAuB,YAAY,EAAE;AAAA,IACvD;AAGA,UAAM,OAAO,MAAM,mBAAmB,YAAY;AAClD,UAAM,UAAU,KAAK;AAGrB,UAAM,WACJF,UAAQ,QAAQ,cAAc,WAC7B,KAAK,WAAW,KAAK,IAAI,SAAS,IAAI,QAAQ,OAAO,EAAE,GAAG,EAAE,IAAI;AAEnE,QAAI,CAAC,UAAU;AACbD,WAAU,mDAAmD;AAC7D,aAAO;AAAA,IACT;AAEA,UAAM,UAAUI,WAAkB,KAAK;AAEvC,QAAI;AACF,YAAM,WAAW,MAAM,QAAQ,KAAK,OAAO,aAAa;AAAA,QACtD,OAAOH,UAAQ,KAAK;AAAA,QACpB,MAAMA,UAAQ,KAAK;AAAA,QACnB,cAAc;AAAA,MAAA,CACf;AAED,YAAM,SAAS,SAAS,KAAK;AAAA,QAC3B,CAAC,YACC,QAAQ,MAAM,SAAS,UAAU,IAAI,kBAAA,CAAmB,WAAW,KACnE,QAAQ,MAAM,SAAS,OAAO;AAAA,MAAA;AAGlC,UAAI,QAAQ;AACVD,aAAU,sCAAsC,QAAQ,qBAAqB;AAC7EK,kBAAe,UAAU,MAAM;AAAA,MACjC,OAAO;AACLL,aAAU,yCAAyC,QAAQ,EAAE;AAC7DK,kBAAe,UAAU,OAAO;AAAA,MAClC;AAEA,aAAO;AAAA,IACT,SAAS,OAAgB;AACvB,YAAM,UAAU,iBAAiB,QAAQ,MAAM,UAAU;AACzDC,cAAa,8CAA8C,OAAO,EAAE;AACpE,aAAO;AAAA,IACT;AAAA,EACF,SAAS,OAAgB;AACvB,UAAM,UAAU,iBAAiB,QAAQ,MAAM,UAAU;AACzDC,cAAe,8BAA8B,OAAO,EAAE;AACtD,UAAM;AAAA,EACR;AACF;AAGA,MAAM,oBACJ,QAAQ,KAAK,CAAC,KAAK,KAAK,QAAQ,QAAQ,KAAK,CAAC,CAAC,MAAM,cAAc,YAAY,GAAG;AAEpF,IAAI,mBAAmB;AACrB,mBAAA;AACF;"}