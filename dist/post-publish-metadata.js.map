{"version":3,"file":"post-publish-metadata.js","sources":["../src/core/post-publish-metadata.ts"],"sourcesContent":["/**\n * post-publish-metadata.ts\n * Posts metadata about the published application for the GitHub Action\n * Used as part of GitHub Action workflows to provide publish information\n */\n\nimport * as fs from \"node:fs\";\nimport * as path from \"node:path\";\nimport { fileURLToPath } from \"node:url\";\n\nimport * as core from \"@actions/core\";\nimport * as github from \"@actions/github\";\nimport type { AppMetadata } from \"../types/metadata\";\nimport { extractAppMetadata } from \"./extract-metadata\";\n\n/**\n * Generates application URL based on environment and app info\n *\n * URLs are constructed based on the environment:\n * - ci: https://fusion.ci.fusion-dev.net\n * - fqa: https://fusion.fqa.fusion-dev.net\n * - fprd: https://fusion.equinor.com (production)\n * - tr: https://fusion.tr.fusion-dev.net\n * - next: https://next.fusion.ci.fusion-dev.net\n *\n * For non-latest tags, includes tag as query parameter for version tracking\n *\n * @param meta - App metadata containing application key\n * @param env - Deployment environment (ci, fqa, fprd, tr, next)\n * @param tag - Deployment tag/version identifier\n * @returns Full application URL to access the deployed application\n * @throws Error if app key is not found in metadata\n * @example\n * const url = generateAppUrl(meta, 'fprd', 'v1.0.0');\n * // Returns: https://fusion.equinor.com/apps/my-app?$tag=v1.0.0\n */\nexport function generateAppUrl(meta: AppMetadata, env: string, tag: string): string {\n  const appKey = meta.key;\n\n  if (!appKey) {\n    throw new Error(\"App key not found in metadata\");\n  }\n\n  // Environment-specific Fusion portal base URLs\n  const envUrls: Record<string, string> = {\n    ci: \"https://fusion.ci.fusion-dev.net\",\n    fqa: \"https://fusion.fqa.fusion-dev.net\",\n    fprd: \"https://fusion.equinor.com\",\n    tr: \"https://fusion.tr.fusion-dev.net\",\n    next: \"https://next.fusion.ci.fusion-dev.net\",\n  };\n\n  const baseUrl = envUrls[env] || envUrls.fprd;\n\n  // Construct application URL\n  if (!tag.startsWith(\"latest\")) {\n    return `${baseUrl}/apps/${appKey}?$tag=${tag}`;\n  }\n\n  return `${baseUrl}/apps/${appKey}`;\n}\n\n/**\n * Posts a comment to the PR with the application URL and deployment info\n *\n * This function:\n * - Checks for GITHUB_TOKEN availability (required for posting comments)\n * - Detects PR number from GitHub context or tag (for pr-{number} format)\n * - Creates a formatted Markdown comment with:\n *   - Application name, version, environment, tag\n *   - Direct links to the deployed application\n *   - Deployment metadata for tracking\n * - Uses meta comment identifier to allow checking for existing comments\n *\n * If not in a PR context (no PR number available), this function silently returns\n * without posting.\n *\n * @param meta - App metadata object\n * @param tag - Deployment tag/version\n * @param appUrl - Generated application URL\n * @throws Does not throw, but logs warnings on failure\n */\nexport async function postPrComment(meta: AppMetadata, tag: string, appUrl: string): Promise<void> {\n  try {\n    const token = process.env.GITHUB_TOKEN;\n    if (!token) {\n      core.info(\"GITHUB_TOKEN not available, skipping PR comment\");\n      return;\n    }\n\n    const octokit = github.getOctokit(token);\n    const context = github.context;\n\n    // Only post comment for PR events or when PR number is available\n    const prNumber =\n      context.payload.pull_request?.number ||\n      (tag?.startsWith(\"pr-\") ? parseInt(tag.replace(\"pr-\", \"\"), 10) : null);\n\n    if (!prNumber) {\n      core.info(\"Not a PR deployment, skipping PR comment\");\n      return;\n    }\n\n    const appName = meta.name;\n\n    // Create formatted comment with deployment details\n    const commentBody = `\n### ðŸš€ ${tag.toLocaleUpperCase()} Deployed\nPreview [${appName}](${appUrl}) in Fusion PR Portal.\n    `;\n\n    await octokit.rest.issues.createComment({\n      owner: context.repo.owner,\n      repo: context.repo.repo,\n      issue_number: prNumber,\n      body: commentBody,\n    });\n\n    core.info(`Posted deployment comment to PR #${prNumber}`);\n  } catch (error: unknown) {\n    const message = error instanceof Error ? error.message : \"Unknown error\";\n    core.warning(`Failed to post PR comment: ${message}`);\n  }\n}\n\n/**\n * Main function to extract metadata and post publish information\n *\n * This is the primary orchestration function that:\n * 1. Reads GitHub Action inputs (artifact, environment, tag, working directory)\n * 2. Resolves the artifact file path\n * 3. Extracts application metadata from the artifact's metadata.json\n * 4. Generates application URLs for different contexts\n * 5. Sets GitHub Action outputs for downstream steps:\n *    - app-name: Application name from metadata\n *    - app-version: Application semantic version\n *    - app-key: Application unique identifier\n *    - app-url: URL to access deployed application\n *    - app-admin-url: URL to access app admin panel\n *    - publish-info: Formatted summary for notifications\n * 6. Posts deployment comment to PR (if applicable)\n *\n * This function is typically called directly as the entry point when the module\n * is executed in a GitHub Action workflow.\n *\n * @throws Does not throw, but calls core.setFailed() on errors\n */\nexport async function postPublishMetadata(): Promise<void> {\n  try {\n    const artifact = core.getInput(\"artifact\");\n    const env = core.getInput(\"env\");\n    const tag = core.getInput(\"tag\");\n    const workingDirectory = core.getInput(\"working-directory\") || \".\";\n\n    core.info(`Processing artifact: ${artifact}`);\n    core.info(`Environment: ${env}`);\n    core.info(`Tag: ${tag}`);\n\n    // Resolve artifact path\n    const artifactPath = path.resolve(workingDirectory, artifact);\n\n    if (!fs.existsSync(artifactPath)) {\n      throw new Error(`Artifact not found: ${artifactPath}`);\n    }\n\n    // Extract app metadata from artifact\n    const meta = await extractAppMetadata(artifactPath);\n\n    const appName = meta.name;\n    const appVersion = meta.version || \"unknown\";\n    const appKey = meta.key;\n\n    core.info(`App Name: ${appName}`);\n    core.info(`App Version: ${appVersion}`);\n    core.info(`App Key: ${appKey}`);\n\n    // Generate application URL\n    const appUrl = generateAppUrl(meta, env, tag);\n    core.info(`App URL: ${appUrl}`);\n\n    // Set outputs for use in other steps\n    core.setOutput(\"app-name\", appName);\n    core.setOutput(\"app-version\", appVersion);\n    core.setOutput(\"app-key\", appKey);\n    core.setOutput(\"app-url\", appUrl);\n\n    // Create formatted publish info for PR comments\n    const publishInfo = `ðŸš€ **${appName}** v${appVersion} deployed to **${env.toUpperCase()}**\\n[Open Application](${appUrl})`;\n    core.setOutput(\"publish-info\", publishInfo);\n\n    // Post comment to PR if applicable\n    await postPrComment(meta, tag, appUrl);\n\n    core.info(\"Post-publish metadata processing completed successfully\");\n  } catch (error: unknown) {\n    const message = error instanceof Error ? error.message : \"Unknown error\";\n    core.setFailed(`Post-publish metadata failed: ${message}`);\n  }\n}\n\n// Execute if called directly\nconst isDirectExecution =\n  process.argv[1] && path.resolve(process.argv[1]) === fileURLToPath(import.meta.url);\n\nif (isDirectExecution) {\n  postPublishMetadata();\n}\n"],"names":["core.info","github.getOctokit","context","github.context","core.warning","core.getInput","core.setOutput","core.setFailed"],"mappings":";;;;;;AAoCO,SAAS,eAAe,MAAmB,KAAa,KAAqB;AAClF,QAAM,SAAS,KAAK;AAEpB,MAAI,CAAC,QAAQ;AACX,UAAM,IAAI,MAAM,+BAA+B;AAAA,EACjD;AAGA,QAAM,UAAkC;AAAA,IACtC,IAAI;AAAA,IACJ,KAAK;AAAA,IACL,MAAM;AAAA,IACN,IAAI;AAAA,IACJ,MAAM;AAAA,EAAA;AAGR,QAAM,UAAU,QAAQ,GAAG,KAAK,QAAQ;AAGxC,MAAI,CAAC,IAAI,WAAW,QAAQ,GAAG;AAC7B,WAAO,GAAG,OAAO,SAAS,MAAM,SAAS,GAAG;AAAA,EAC9C;AAEA,SAAO,GAAG,OAAO,SAAS,MAAM;AAClC;AAsBA,eAAsB,cAAc,MAAmB,KAAa,QAA+B;AACjG,MAAI;AACF,UAAM,QAAQ,QAAQ,IAAI;AAC1B,QAAI,CAAC,OAAO;AACVA,WAAU,iDAAiD;AAC3D;AAAA,IACF;AAEA,UAAM,UAAUC,WAAkB,KAAK;AACvC,UAAMC,YAAUC;AAGhB,UAAM,WACJD,UAAQ,QAAQ,cAAc,WAC7B,KAAK,WAAW,KAAK,IAAI,SAAS,IAAI,QAAQ,OAAO,EAAE,GAAG,EAAE,IAAI;AAEnE,QAAI,CAAC,UAAU;AACbF,WAAU,0CAA0C;AACpD;AAAA,IACF;AAEA,UAAM,UAAU,KAAK;AAGrB,UAAM,cAAc;AAAA,SACf,IAAI,mBAAmB;AAAA,WACrB,OAAO,KAAK,MAAM;AAAA;AAGzB,UAAM,QAAQ,KAAK,OAAO,cAAc;AAAA,MACtC,OAAOE,UAAQ,KAAK;AAAA,MACpB,MAAMA,UAAQ,KAAK;AAAA,MACnB,cAAc;AAAA,MACd,MAAM;AAAA,IAAA,CACP;AAEDF,SAAU,oCAAoC,QAAQ,EAAE;AAAA,EAC1D,SAAS,OAAgB;AACvB,UAAM,UAAU,iBAAiB,QAAQ,MAAM,UAAU;AACzDI,YAAa,8BAA8B,OAAO,EAAE;AAAA,EACtD;AACF;AAwBA,eAAsB,sBAAqC;AACzD,MAAI;AACF,UAAM,WAAWC,SAAc,UAAU;AACzC,UAAM,MAAMA,SAAc,KAAK;AAC/B,UAAM,MAAMA,SAAc,KAAK;AAC/B,UAAM,mBAAmBA,SAAc,mBAAmB,KAAK;AAE/DL,SAAU,wBAAwB,QAAQ,EAAE;AAC5CA,SAAU,gBAAgB,GAAG,EAAE;AAC/BA,SAAU,QAAQ,GAAG,EAAE;AAGvB,UAAM,eAAe,KAAK,QAAQ,kBAAkB,QAAQ;AAE5D,QAAI,CAAC,GAAG,WAAW,YAAY,GAAG;AAChC,YAAM,IAAI,MAAM,uBAAuB,YAAY,EAAE;AAAA,IACvD;AAGA,UAAM,OAAO,MAAM,mBAAmB,YAAY;AAElD,UAAM,UAAU,KAAK;AACrB,UAAM,aAAa,KAAK,WAAW;AACnC,UAAM,SAAS,KAAK;AAEpBA,SAAU,aAAa,OAAO,EAAE;AAChCA,SAAU,gBAAgB,UAAU,EAAE;AACtCA,SAAU,YAAY,MAAM,EAAE;AAG9B,UAAM,SAAS,eAAe,MAAM,KAAK,GAAG;AAC5CA,SAAU,YAAY,MAAM,EAAE;AAG9BM,cAAe,YAAY,OAAO;AAClCA,cAAe,eAAe,UAAU;AACxCA,cAAe,WAAW,MAAM;AAChCA,cAAe,WAAW,MAAM;AAGhC,UAAM,cAAc,QAAQ,OAAO,OAAO,UAAU,kBAAkB,IAAI,aAAa;AAAA,qBAA0B,MAAM;AACvHA,cAAe,gBAAgB,WAAW;AAG1C,UAAM,cAAc,MAAM,KAAK,MAAM;AAErCN,SAAU,yDAAyD;AAAA,EACrE,SAAS,OAAgB;AACvB,UAAM,UAAU,iBAAiB,QAAQ,MAAM,UAAU;AACzDO,cAAe,iCAAiC,OAAO,EAAE;AAAA,EAC3D;AACF;AAGA,MAAM,oBACJ,QAAQ,KAAK,CAAC,KAAK,KAAK,QAAQ,QAAQ,KAAK,CAAC,CAAC,MAAM,cAAc,YAAY,GAAG;AAEpF,IAAI,mBAAmB;AACrB,sBAAA;AACF;"}