{"version":3,"file":"validate-is-token-or-azure.js","sources":["../src/core/validate-is-token-or-azure.ts"],"sourcesContent":["/**\n * validate-is-token-or-azure.ts\n *\n * Validates and detects the authentication method for the GitHub Action\n *\n * This module provides authentication validation for two methods:\n * 1. **Direct Token**: User provides pre-acquired Fusion API token\n * 2. **Azure Service Principal (OIDC)**: User provides Azure AD credentials for OIDC flow\n *\n * The module handles:\n * - Token format validation (must start with 'BEARER ')\n * - Azure credential detection and validation (requires all 3 fields)\n * - Authentication type prioritization when both methods provided\n *\n * Used as part of GitHub Action workflows to ensure authentication credentials\n * are valid before attempting to publish the application.\n */\n\nimport * as path from \"node:path\";\nimport { fileURLToPath } from \"node:url\";\nimport * as core from \"@actions/core\";\nimport type { AuthDetectionResult, AuthType, Credentials, ValidationResult } from \"../types/auth\";\n\n/**\n * Enumeration of supported authentication types\n * Used to identify which authentication method is being used\n * @example\n * if (authType === AUTH_TYPES.TOKEN) { ... }\n */\nexport const AUTH_TYPES = {\n  TOKEN: \"token\",\n  SERVICE_PRINCIPAL: \"service-principal\",\n} as const satisfies Record<string, AuthType>;\n\n/**\n * Validates Fusion token format and structure\n *\n * Checks that the token:\n * - Is a non-empty string\n * - Starts with 'BEARER ' (case-sensitive)\n * - Contains only valid token characters after the prefix (alphanumeric, ., _, -)\n *\n * @param token - The Fusion token to validate\n * @returns ValidationResult with isValid flag and error message if validation fails\n * @example\n * const result = validateFusionToken('BEARER abc123-._');\n * if (result.isValid) { ... }\n */\nexport function validateFusionToken(token: string): ValidationResult {\n  // Validate that the fusion-token is a non-empty string\n  if (!token || typeof token !== \"string\" || token.trim() === \"\") {\n    return {\n      isValid: false,\n      error: \"Input 'fusion-token' must be a non-empty string.\",\n    };\n  }\n\n  // Validate the format of the fusion-token\n  const tokenPattern = /^BEARER [A-Za-z0-9._-]+$/;\n  if (!tokenPattern.test(token)) {\n    return {\n      isValid: false,\n      error:\n        \"Input 'fusion-token' is not in the correct format. It should start with 'BEARER ' followed by valid token characters.\",\n    };\n  }\n\n  return {\n    isValid: true,\n    error: null,\n  };\n}\n\n/**\n * Detects the authentication type and validates credentials\n *\n * Detection logic (in order of precedence):\n * 1. If both token and complete Azure credentials provided: Use Service Principal (prefers SP)\n * 2. If only token provided: Use token authentication\n * 3. If complete Azure credentials provided: Use Service Principal\n * 4. If partial Azure credentials: Error (all 3 required)\n * 5. No credentials: Error\n *\n * @param credentials - Object containing all potential credential inputs\n * @returns AuthDetectionResult with detected authType, isValid flag, and error message\n * @example\n * const result = detectAndValidateAuthType({\n *   fusionToken: 'BEARER abc123',\n *   azureClientId: '',\n *   azureTenantId: '',\n *   azureResourceId: ''\n * });\n * // Returns: { authType: 'token', isValid: true, error: null }\n */\nexport function detectAndValidateAuthType(credentials: Credentials): AuthDetectionResult {\n  const { fusionToken, azureClientId, azureTenantId, azureResourceId } = credentials;\n\n  // Trim and check for non-empty credentials\n  const trimmedFusionToken = fusionToken?.trim() ?? \"\";\n  const trimmedAzureClientId = azureClientId?.trim() ?? \"\";\n  const trimmedAzureTenantId = azureTenantId?.trim() ?? \"\";\n  const trimmedAzureResourceId = azureResourceId?.trim() ?? \"\";\n\n  // Check if Azure Service Principal credentials are provided\n  const hasAzureCredentials =\n    trimmedAzureClientId && trimmedAzureTenantId && trimmedAzureResourceId;\n  const hasPartialAzureCredentials =\n    trimmedAzureClientId || trimmedAzureTenantId || trimmedAzureResourceId;\n\n  // If we have both token and Azure credentials\n  if (trimmedFusionToken && hasAzureCredentials) {\n    // Prefer Service Principal when both are provided\n    core.info(\"Both token and Azure credentials provided. Using Service Principal authentication.\");\n    return {\n      authType: AUTH_TYPES.SERVICE_PRINCIPAL,\n      isValid: true,\n      error: null,\n    };\n  }\n\n  // If we have a token and no Azure credentials\n  if (trimmedFusionToken && !hasPartialAzureCredentials) {\n    return {\n      authType: AUTH_TYPES.TOKEN,\n      isValid: true,\n      error: null,\n    };\n  }\n\n  // If we have all Azure credentials\n  if (hasAzureCredentials) {\n    return {\n      authType: AUTH_TYPES.SERVICE_PRINCIPAL,\n      isValid: true,\n      error: null,\n    };\n  }\n\n  // If we have partial Azure credentials (invalid state)\n  if (hasPartialAzureCredentials && !hasAzureCredentials) {\n    return {\n      authType: null,\n      isValid: false,\n      error:\n        \"All Azure credentials ('azure-client-id', 'azure-tenant-id', 'azure-resource-id') must be provided when using Service Principal authentication.\",\n    };\n  }\n\n  // No valid credentials provided\n  return {\n    authType: null,\n    isValid: false,\n    error:\n      \"Either 'fusion-token' or all Azure credentials ('azure-client-id', 'azure-tenant-id', 'azure-resource-id') must be provided.\",\n  };\n}\n\n/**\n * Main function to validate the authentication inputs\n *\n * This is the primary entry point for authentication validation:\n * 1. Collects all authentication inputs from GitHub Action environment\n * 2. Calls detectAndValidateAuthType to determine auth method and validate\n * 3. Sets GitHub Action outputs for downstream reference:\n *    - auth-type: The authentication method used (token or service-principal)\n *    - isToken: Boolean indicating token authentication\n *    - isServicePrincipal: Boolean indicating SP authentication\n * 4. Fails the action if validation fails\n *\n * This function is typically called directly as the entry point when the module\n * is executed in a GitHub Action workflow.\n *\n * @throws Does not throw, but calls core.setFailed() on validation errors\n */\nexport function validateIsTokenOrAzure(): void {\n  // Get all authentication inputs from GitHub Action\n  // Using core.getInput with hyphenated names - it automatically converts to INPUT_* env vars\n  let fusionToken = core.getInput(\"fusion-token\");\n  let azureClientId = core.getInput(\"azure-client-id\");\n  let azureTenantId = core.getInput(\"azure-tenant-id\");\n  let azureResourceId = core.getInput(\"azure-resource-id\");\n\n  // Fallback to direct environment variables if core.getInput returns empty\n  // This handles cases where input names might not be resolved correctly\n  if (!fusionToken) {\n    fusionToken = process.env.INPUT_FUSION_TOKEN ?? \"\";\n  }\n  if (!azureClientId) {\n    azureClientId = process.env.INPUT_AZURE_CLIENT_ID ?? \"\";\n  }\n  if (!azureTenantId) {\n    azureTenantId = process.env.INPUT_AZURE_TENANT_ID ?? \"\";\n  }\n  if (!azureResourceId) {\n    azureResourceId = process.env.INPUT_AZURE_RESOURCE_ID ?? \"\";\n  }\n\n  const credentials: Credentials = {\n    fusionToken,\n    azureClientId,\n    azureTenantId,\n    azureResourceId,\n  };\n\n  // Log for debugging (will appear in GitHub Action logs)\n  core.debug(`Azure Client ID provided: ${!!azureClientId}`);\n  core.debug(`Azure Tenant ID provided: ${!!azureTenantId}`);\n  core.debug(`Azure Resource ID provided: ${!!azureResourceId}`);\n  core.debug(`Fusion Token provided: ${!!fusionToken}`);\n\n  // Detect authentication type and validate credentials\n  const authResult = detectAndValidateAuthType(credentials);\n\n  if (!authResult.isValid) {\n    const message = authResult.error ?? \"Authentication validation failed.\";\n    core.setFailed(message);\n    return;\n  }\n\n  // Set outputs for authentication type information\n  core.setOutput(\"auth-type\", authResult.authType);\n  core.setOutput(\"isToken\", authResult.authType === AUTH_TYPES.TOKEN);\n  core.setOutput(\"isServicePrincipal\", authResult.authType === AUTH_TYPES.SERVICE_PRINCIPAL);\n\n  // If using token authentication, validate the token format\n  if (authResult.authType === AUTH_TYPES.TOKEN) {\n    const tokenValidation = validateFusionToken(credentials.fusionToken.trim());\n\n    if (!tokenValidation.isValid) {\n      const message = tokenValidation.error ?? \"Invalid fusion token.\";\n      core.setFailed(message);\n      return;\n    }\n\n    core.info(\"Fusion token validation passed.\");\n  } else if (authResult.authType === AUTH_TYPES.SERVICE_PRINCIPAL) {\n    core.info(\"Azure Service Principal credentials validated.\");\n  }\n}\n\n// Execute if called directly\nconst isDirectExecution =\n  process.argv[1] && path.resolve(process.argv[1]) === fileURLToPath(import.meta.url);\n\nif (isDirectExecution) {\n  validateIsTokenOrAzure();\n}\n"],"names":["core.info","core.getInput","core.debug","core.setFailed","core.setOutput"],"mappings":"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"}